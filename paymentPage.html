<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n - Pet Store</title>
    <link rel="stylesheet" href="webThuCung.css" />
    <link rel="stylesheet" href="product.css" />
    <link rel="stylesheet" href="paymentPage.css" />
  </head>
  <body>
    <header class="header-1">
      <div class="logo">
        <a href="webThuCung.html">
          <img src="images/logo.avif" alt="logo" />
        </a>
      </div>
      <form action="#" method="get" class="search-form" id="search-form">
        <input
          type="text"
          name="search"
          placeholder="Search pets..."
          id="search-input"
        />
        <button class="button" type="submit">Search</button>
      </form>
      <nav class="nav">
        <ul class="nav-list">
          <li><a href="webThuCung.html">Home</a></li>
          <li><a href="product.html">Product</a></li>
          <li><a href="#con">Contact</a></li>
          <li id="auth-links" class="fasUsers">
            <a href="login.html" id="login-link">Login</a>
            <a href="register.html" id="register-link">Register</a>
          </li>
          <li id="account-link" style="display: none">
            <a href="account.html">My Account</a>
            <a href="#" id="logout-link">Logout</a>
          </li>
          <li>
            <a href="cart.html" id="cart-link"
              >Cart(<span id="cart-count">0</span>)</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <main class="payment-container">
      <div class="payment-header">
        <h1>Thanh to√°n ƒë∆°n h√†ng</h1>
        <div class="payment-steps">
          <div class="step completed">
            <span class="step-number">‚úì</span>
            <span class="step-label">Gi·ªè h√†ng</span>
          </div>
          <div class="step completed">
            <span class="step-number">‚úì</span>
            <span class="step-label">Th√¥ng tin</span>
          </div>
          <div class="step active">
            <span class="step-number">3</span>
            <span class="step-label">Thanh to√°n</span>
          </div>
        </div>
      </div>

      <div class="payment-content">
        <div class="payment-main">
          <div class="payment-section">
            <h2 class="section-title">
              <span class="title-icon">üí≥</span>
              Ph∆∞∆°ng th·ª©c thanh to√°n
            </h2>
            <div class="payment-methods">
              <div class="payment-method-card" data-method="creditCard">
                <input
                  type="radio"
                  id="creditCard"
                  name="paymentMethod"
                  value="creditCard"
                  checked
                />
                <label for="creditCard">
                  <div class="method-header">
                    <span class="method-icon">üí≥</span>
                    <span class="method-name">Th·∫ª t√≠n d·ª•ng / Ghi n·ª£</span>
                  </div>
                  <div class="method-description">
                    Visa, Mastercard, American Express
                  </div>
                </label>
              </div>

              <div class="payment-method-card" data-method="bankTransfer">
                <input
                  type="radio"
                  id="bankTransfer"
                  name="paymentMethod"
                  value="bankTransfer"
                />
                <label for="bankTransfer">
                  <div class="method-header">
                    <span class="method-icon">üè¶</span>
                    <span class="method-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                  </div>
                  <div class="method-description">
                    Chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp v√†o t√†i kho·∫£n ng√¢n h√†ng
                  </div>
                </label>
              </div>

              <div class="payment-method-card" data-method="cod">
                <input
                  type="radio"
                  id="cod"
                  name="paymentMethod"
                  value="cod"
                />
                <label for="cod">
                  <div class="method-header">
                    <span class="method-icon">üí∞</span>
                    <span class="method-name">Thanh to√°n khi nh·∫≠n h√†ng</span>
                  </div>
                  <div class="method-description">
                    Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n ƒë∆∞·ª£c h√†ng
                  </div>
                </label>
              </div>

              <div class="payment-method-card" data-method="momo">
                <input
                  type="radio"
                  id="momo"
                  name="paymentMethod"
                  value="momo"
                />
                <label for="momo">
                  <div class="method-header">
                    <span class="method-icon">üì±</span>
                    <span class="method-name">V√≠ ƒëi·ªán t·ª≠ MoMo</span>
                  </div>
                  <div class="method-description">
                    Thanh to√°n nhanh qua ·ª©ng d·ª•ng MoMo
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Credit Card Form -->
          <div id="creditCardForm" class="payment-form-section">
            <h2 class="section-title">
              <span class="title-icon">üîí</span>
              Th√¥ng tin th·∫ª
            </h2>
            <form id="cardForm" class="card-form">
              <div class="form-group">
                <label for="cardNumber">S·ªë th·∫ª *</label>
                <input
                  type="text"
                  id="cardNumber"
                  name="cardNumber"
                  placeholder="1234 5678 9012 3456"
                  maxlength="19"
                  required
                />
                <div class="card-icons">
                  <span class="card-icon">üí≥</span>
                  <span class="card-icon">üí≥</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="expiryDate">Ng√†y h·∫øt h·∫°n *</label>
                  <input
                    type="text"
                    id="expiryDate"
                    name="expiryDate"
                    placeholder="MM/YY"
                    maxlength="5"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="cvv">CVV *</label>
                  <input
                    type="text"
                    id="cvv"
                    name="cvv"
                    placeholder="123"
                    maxlength="4"
                    required
                  />
                  <span class="cvv-hint">3-4 s·ªë ·ªü m·∫∑t sau th·∫ª</span>
                </div>
              </div>

              <div class="form-group">
                <label for="cardName">T√™n ch·ªß th·∫ª *</label>
                <input
                  type="text"
                  id="cardName"
                  name="cardName"
                  placeholder="NGUYEN VAN A"
                  required
                />
              </div>
            </form>
          </div>

          <!-- Bank Transfer Info -->
          <div id="bankTransferInfo" class="payment-info-section" style="display: none;">
            <h2 class="section-title">
              <span class="title-icon">üè¶</span>
              Th√¥ng tin chuy·ªÉn kho·∫£n
            </h2>
            <div class="bank-info">
              <div class="info-item">
                <span class="info-label">Ng√¢n h√†ng:</span>
                <span class="info-value">Vietcombank</span>
              </div>
              <div class="info-item">
                <span class="info-label">S·ªë t√†i kho·∫£n:</span>
                <span class="info-value">0123456789</span>
              </div>
              <div class="info-item">
                <span class="info-label">Ch·ªß t√†i kho·∫£n:</span>
                <span class="info-value">PET STORE COMPANY</span>
              </div>
              <div class="info-item">
                <span class="info-label">N·ªôi dung chuy·ªÉn kho·∫£n:</span>
                <span class="info-value" id="transferContent">DH-<span id="orderIdDisplay"></span></span>
              </div>
              <div class="info-note">
                <p>‚ö†Ô∏è Vui l√≤ng chuy·ªÉn kho·∫£n ƒë√∫ng s·ªë ti·ªÅn v√† n·ªôi dung ƒë·ªÉ ƒë∆°n h√†ng ƒë∆∞·ª£c x·ª≠ l√Ω nhanh nh·∫•t.</p>
              </div>
            </div>
          </div>

          <!-- MoMo Payment Info -->
          <div id="momoInfo" class="payment-info-section" style="display: none;">
            <h2 class="section-title">
              <span class="title-icon">üì±</span>
              Thanh to√°n MoMo
            </h2>
            <div class="momo-info">
              <div class="qr-code-placeholder">
                <div class="qr-code">
                  <div class="qr-pattern"></div>
                  <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                </div>
              </div>
              <div class="momo-steps">
                <div class="step-item">
                  <span class="step-num">1</span>
                  <span>M·ªü ·ª©ng d·ª•ng MoMo</span>
                </div>
                <div class="step-item">
                  <span class="step-num">2</span>
                  <span>Qu√©t m√£ QR b√™n c·∫°nh</span>
                </div>
                <div class="step-item">
                  <span class="step-num">3</span>
                  <span>X√°c nh·∫≠n thanh to√°n</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="payment-sidebar">
          <div class="order-summary-card">
            <h3 class="summary-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
            <div class="order-items" id="orderItems">
              <!-- Items will be loaded here -->
            </div>
            <div class="summary-divider"></div>
            <div class="summary-totals">
              <div class="total-row">
                <span>T·∫°m t√≠nh:</span>
                <span id="subtotal">$0.00</span>
              </div>
              <div class="total-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span id="shipping">$10.00</span>
              </div>
              <div class="total-row">
                <span>Thu·∫ø (10%):</span>
                <span id="tax">$0.00</span>
              </div>
              <div class="total-row total-final">
                <span>T·ªïng c·ªông:</span>
                <span id="total">$0.00</span>
              </div>
            </div>
          </div>

          <div class="security-badge">
            <div class="badge-icon">üîí</div>
            <div class="badge-text">
              <strong>Thanh to√°n an to√†n</strong>
              <p>Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c m√£ h√≥a v√† b·∫£o m·∫≠t</p>
            </div>
          </div>
        </div>
      </div>

      <div class="payment-actions">
        <a href="checkout.html" class="btn btn-back">‚Üê Quay l·∫°i</a>
        <button id="completePaymentBtn" class="btn btn-primary">
          Ho√†n t·∫•t thanh to√°n
        </button>
      </div>
    </main>

    <script type="module">
      // Authentication state management
      function updateAuthState() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const authLinks = document.getElementById("auth-links");
        const accountLink = document.getElementById("account-link");
        const logoutLink = document.getElementById("logout-link");

        if (currentUser) {
          authLinks.style.display = "none";
          accountLink.style.display = "block";
          accountLink.querySelector(
            "a"
          ).textContent = `Hi, ${currentUser.userName}`;
        } else {
          authLinks.style.display = "block";
          accountLink.style.display = "none";
          // Redirect to login if not authenticated
          window.location.href = "login.html";
        }

        // Logout functionality
        logoutLink?.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("currentUser");
          localStorage.removeItem("cart");
          window.location.href = "webThuCung.html";
        });
      }

      // Cart count update
      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const total = cart.reduce((sum, item) => sum + item.quantity, 0);
        const countEl = document.getElementById("cart-count");
        if (countEl) countEl.textContent = total;
      }

      // Load order summary
      function loadOrderSummary() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const orderItemsEl = document.getElementById("orderItems");

        if (cart.length === 0) {
          alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!");
          window.location.href = "cart.html";
          return;
        }

        orderItemsEl.innerHTML = "";
        let subtotal = 0;

        cart.forEach((item) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("order-item");
          itemEl.innerHTML = `
            <div class="item-image">
              <img src="${item.image}" alt="${item.name}" />
            </div>
            <div class="item-details">
              <h4>${item.name}</h4>
              <p class="item-breed">Gi·ªëng: ${item.breed}</p>
              <p class="item-quantity">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
            </div>
            <div class="item-price">$${(item.price * item.quantity).toFixed(
              2
            )}</div>
          `;
          orderItemsEl.appendChild(itemEl);
          subtotal += item.price * item.quantity;
        });

        updateTotals(subtotal);
      }

      function updateTotals(subtotal) {
        const shipping = 10;
        const tax = subtotal * 0.1;
        const total = subtotal + shipping + tax;

        document.getElementById("subtotal").textContent = `$${subtotal.toFixed(
          2
        )}`;
        document.getElementById("shipping").textContent = `$${shipping.toFixed(
          2
        )}`;
        document.getElementById("tax").textContent = `$${tax.toFixed(2)}`;
        document.getElementById("total").textContent = `$${total.toFixed(2)}`;
      }

      // Payment method toggle
      function togglePaymentMethod() {
        const selectedMethod = document.querySelector(
          'input[name="paymentMethod"]:checked'
        )?.value;
        
        if (!selectedMethod) return;
        
        const creditCardForm = document.getElementById("creditCardForm");
        const bankTransferInfo = document.getElementById("bankTransferInfo");
        const momoInfo = document.getElementById("momoInfo");

        // Hide all
        if (creditCardForm) creditCardForm.style.display = "none";
        if (bankTransferInfo) bankTransferInfo.style.display = "none";
        if (momoInfo) momoInfo.style.display = "none";

        // Remove active class from all cards
        document.querySelectorAll(".payment-method-card").forEach((card) => {
          card.classList.remove("active");
        });

        // Add active class to selected card
        const selectedCard = document.querySelector(
          `.payment-method-card[data-method="${selectedMethod}"]`
        );
        if (selectedCard) {
          selectedCard.classList.add("active");
        }

        // Show selected
        if (selectedMethod === "creditCard" && creditCardForm) {
          creditCardForm.style.display = "block";
        } else if (selectedMethod === "bankTransfer" && bankTransferInfo) {
          bankTransferInfo.style.display = "block";
          // Generate order ID for transfer
          const orderId = Date.now();
          const orderIdDisplay = document.getElementById("orderIdDisplay");
          if (orderIdDisplay) {
            orderIdDisplay.textContent = orderId;
          }
        } else if (selectedMethod === "momo" && momoInfo) {
          momoInfo.style.display = "block";
        }
      }

      // Format card number
      document.getElementById("cardNumber")?.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\s/g, "");
        let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
        e.target.value = formattedValue;
      });

      // Format expiry date
      document.getElementById("expiryDate")?.addEventListener("input", (e) => {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.substring(0, 2) + "/" + value.substring(2, 4);
        }
        e.target.value = value;
      });

      // Complete payment
      document
        .getElementById("completePaymentBtn")
        ?.addEventListener("click", () => {
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          if (cart.length === 0) {
            alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!");
            return;
          }

          const paymentMethod = document.querySelector(
            'input[name="paymentMethod"]:checked'
          ).value;

          // Validate credit card if selected
          if (paymentMethod === "creditCard") {
            const cardForm = document.getElementById("cardForm");
            if (!cardForm.checkValidity()) {
              cardForm.reportValidity();
              return;
            }
          }

          // Get checkout data from localStorage or use defaults
          const checkoutData =
            JSON.parse(localStorage.getItem("checkoutData")) || {};
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));

          // Calculate totals
          const subtotal = cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );
          const shipping = 10;
          const tax = subtotal * 0.1;
          const total = subtotal + shipping + tax;

          // Create order
          const order = {
            id: Date.now(),
            date: new Date().toISOString(),
            customer: {
              ...checkoutData,
              email: currentUser?.email || checkoutData.email,
              userName: currentUser?.userName || checkoutData.firstName,
            },
            items: cart,
            paymentMethod: paymentMethod,
            status: "pending",
            total: total,
          };

          // Save order
          const orders = JSON.parse(localStorage.getItem("orders")) || [];
          orders.push(order);
          localStorage.setItem("orders", JSON.stringify(orders));

          // Clear cart
          localStorage.removeItem("cart");
          localStorage.removeItem("checkoutData");

          // Show success and redirect
          alert("Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng!");
          window.location.href = `orderConfirmationPage.html?orderId=${order.id}`;
        });

      // Payment method change handlers
      document
        .querySelectorAll('input[name="paymentMethod"]')
        .forEach((radio) => {
          radio.addEventListener("change", togglePaymentMethod);
        });

      // Initialize
      updateAuthState();
      updateCartCount();
      loadOrderSummary();
      togglePaymentMethod();
    </script>
  </body>
</html>

