<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Products - Pet Store</title>
    <link rel="stylesheet" href="webThuCung.css" />
    <link rel="stylesheet" href="product.css" />
  </head>
  <body>
    <header class="header-1">
      <div class="logo">
        <a href="webThuCung.html"><img src="images/logo.avif" alt="logo" /></a>
      </div>
      <form class="search-form" id="search-form">
        <input type="text" id="search-input" placeholder="Search pets..." />
        <button type="submit">Search</button>
      </form>
      <nav class="nav">
        <ul class="nav-list">
          <li><a href="webThuCung.html">Home</a></li>
          <li><a href="product.html">Product</a></li>
          <li><a href="#con">Contact</a></li>
          <li id="auth-links" class="fasUsers">
            <a href="login.html" id="login-link">Login</a>
            <a href="register.html" id="register-link">Register</a>
          </li>
          <li id="account-link" style="display: none">
            <a href="account.html">My Account</a>
            <a href="#" id="logout-link">Logout</a>
          </li>
          <li>
            <a href="cart.html" id="cart-link"
              >Cart(<span id="cart-count">0</span>)</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <main class="product-main">
      <section class="products">
        <div class="products-header">
          <h2 class="products-title">Danh sách sản phẩm</h2>
          <p class="products-subtitle">
            Khám phá những người bạn bốn chân đáng yêu
          </p>
        </div>
        <div class="product-filters">
          <div class="filter-group">
            <label for="sortOption" class="filter-label"> Sắp xếp </label>
            <select id="sortOption" class="filter-select">
              <option value="default">Mặc định</option>
              <option value="priceAsc">Giá tăng dần</option>
              <option value="priceDesc">Giá giảm dần</option>
              <option value="nameAZ">Tên A-Z</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="minPrice" class="filter-label"> Khoảng giá </label>
            <div class="price-inputs">
              <input
                type="number"
                id="minPrice"
                placeholder="Từ $"
                class="price-input"
              />
              <span class="price-separator">-</span>
              <input
                type="number"
                id="maxPrice"
                placeholder="Đến $"
                class="price-input"
              />
            </div>
          </div>
          <button id="filterPrice" class="filter-btn">Lọc</button>
        </div>
        <div class="product-grid" id="product-list"></div>
        <div id="pagination" class="pagination-container"></div>
      </section>
    </main>

    <script type="module">
      import { petsData } from "./js/mock-data.js";

      const listEl = document.getElementById("product-list");
      const paginationEl = document.getElementById("pagination");
      const minPriceEl = document.getElementById("minPrice");
      const maxPriceEl = document.getElementById("maxPrice");
      const sortEl = document.getElementById("sortOption");
      const filterBtn = document.getElementById("filterPrice");

      let currentPage = 1;
      const perPage = 6;

      function applyFilters(data) {
        const searchInput = document.getElementById("search-input");
        const searchTerm = searchInput.value.toLowerCase().trim();
        const searchTerms = searchTerm
          ? searchTerm.split(" ").filter((term) => term.length > 0)
          : [];
        const min = parseFloat(minPriceEl.value) || 0;
        const max = parseFloat(maxPriceEl.value) || Infinity;

        let result = data.filter((p) => {
          // Search by name - check if all search terms are found
          const nameMatch =
            searchTerms.length === 0 ||
            searchTerms.every((term) => p.name.toLowerCase().includes(term));

          // Also search by breed
          const breedMatch =
            searchTerms.length === 0 ||
            searchTerms.some((term) => p.breed.toLowerCase().includes(term));

          return (nameMatch || breedMatch) && p.price >= min && p.price <= max;
        });

        switch (sortEl.value) {
          case "priceAsc":
            result.sort((a, b) => a.price - b.price);
            break;
          case "priceDesc":
            result.sort((a, b) => b.price - a.price);
            break;
          case "nameAZ":
            result.sort((a, b) => a.name.localeCompare(b.name));
            break;
        }

        return result;
      }

      function renderPagination(total) {
        const pages = Math.ceil(total / perPage);
        paginationEl.innerHTML = "";

        if (pages <= 1) return;

        // Previous button
        const prevBtn = document.createElement("button");
        prevBtn.innerHTML = "‹";
        prevBtn.className = "pagination-btn";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        };
        paginationEl.appendChild(prevBtn);

        // Page numbers
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(pages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
          startPage = Math.max(1, endPage - maxVisible + 1);
        }

        // First page
        if (startPage > 1) {
          const firstBtn = document.createElement("button");
          firstBtn.textContent = "1";
          firstBtn.onclick = () => {
            currentPage = 1;
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
          paginationEl.appendChild(firstBtn);

          if (startPage > 2) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            ellipsis.className = "pagination-ellipsis";
            paginationEl.appendChild(ellipsis);
          }
        }

        // Page number buttons
        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.onclick = () => {
            currentPage = i;
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
          if (i === currentPage) btn.classList.add("active");
          paginationEl.appendChild(btn);
        }

        // Last page
        if (endPage < pages) {
          if (endPage < pages - 1) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            ellipsis.className = "pagination-ellipsis";
            paginationEl.appendChild(ellipsis);
          }

          const lastBtn = document.createElement("button");
          lastBtn.textContent = pages;
          lastBtn.onclick = () => {
            currentPage = pages;
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
          paginationEl.appendChild(lastBtn);
        }

        // Next button
        const nextBtn = document.createElement("button");
        nextBtn.innerHTML = "›";
        nextBtn.className = "pagination-btn";
        nextBtn.disabled = currentPage === pages;
        nextBtn.onclick = () => {
          if (currentPage < pages) {
            currentPage++;
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        };
        paginationEl.appendChild(nextBtn);
      }

      function render() {
        const filtered = applyFilters(petsData);
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const sliced = filtered.slice(start, end);

        listEl.innerHTML = "";
        sliced.forEach((pet) => {
          const div = document.createElement("div");
          div.className = "pet-card";
          div.style.cursor = "pointer";
          div.innerHTML = `
          <img src="${pet.image}" alt="${pet.name}" class="product-image" />
          <h3 class="product-name">${pet.name}</h3>
          <p>Giống: ${pet.breed}</p>
          <p>Tuổi: ${pet.age}</p>
          <p>Giới tính: ${pet.gender}</p>
          <div class="star-rating">
            <span class="rating">${pet.reviews.rating.toFixed(1)}</span>
            <span class="stars">${"★".repeat(
              Math.round(pet.reviews.rating)
            )}${"☆".repeat(5 - Math.round(pet.reviews.rating))}</span>
          </div>
          <p class="product-price">$${pet.price}</p>
          <button class="add-to-cart" data-id="${pet.id}">Thêm vào giỏ</button>
        `;

          // Add click event to navigate to product detail
          div.addEventListener("click", (e) => {
            if (!e.target.classList.contains("add-to-cart")) {
              window.location.href = `productDetail.html?id=${pet.id}`;
            }
          });

          // Add event listener for add to cart button
          const addToCartBtn = div.querySelector(".add-to-cart");
          addToCartBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            addToCart(pet.id);
          });

          listEl.appendChild(div);
        });

        renderPagination(filtered.length);
      }

      document.getElementById("search-form").addEventListener("submit", (e) => {
        e.preventDefault();
        currentPage = 1;
        // Update URL with search query
        const searchTerm = document.getElementById("search-input").value.trim();
        const url = new URL(window.location);
        if (searchTerm) {
          url.searchParams.set("search", searchTerm);
        } else {
          url.searchParams.delete("search");
        }
        window.history.pushState({}, "", url);
        render();
      });

      sortEl.addEventListener("change", () => render());
      filterBtn.addEventListener("click", () => render());

      // Check for search query parameter on page load
      const urlParams = new URLSearchParams(window.location.search);
      let searchQuery = urlParams.get("search");
      if (searchQuery) {
        document.getElementById("search-input").value = searchQuery;
        // Render with search query applied
        currentPage = 1;
        render();
      }

      // Authentication state management
      function updateAuthState() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const authLinks = document.getElementById("auth-links");
        const accountLink = document.getElementById("account-link");
        const logoutLink = document.getElementById("logout-link");

        if (currentUser) {
          authLinks.style.display = "none";
          accountLink.style.display = "block";
          accountLink.querySelector(
            "a"
          ).textContent = `Hi, ${currentUser.userName}`;
        } else {
          authLinks.style.display = "block";
          accountLink.style.display = "none";
        }

        // Logout functionality
        logoutLink?.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("currentUser");
          localStorage.removeItem("cart");
          window.location.href = "webThuCung.html";
        });
      }

      // Cart count update
      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const total = cart.reduce((sum, item) => sum + item.quantity, 0);
        const countEl = document.getElementById("cart-count");
        if (countEl) countEl.textContent = total;
      }

      // Add to cart function
      function addToCart(id) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng");
          window.location.href = "login.html";
          return;
        }
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existingItem = cart.find((item) => item.id === id);

        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          const pet = petsData.find((p) => p.id === id);
          cart.push({ ...pet, quantity: 1 });
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        alert("Đã thêm vào giỏ hàng!");
      }

      // Initialize
      updateAuthState();
      updateCartCount();

      // Only render if no search query (search query already triggers render)
      if (!searchQuery) {
        render();
      }
    </script>
  </body>
</html>
