<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt s·∫£n ph·∫©m - Pet Store</title>
    <link rel="stylesheet" href="webThuCung.css" />
    <link rel="stylesheet" href="product.css" />
    <link rel="stylesheet" href="ProductDetail.css" />
  </head>
  <body>
    <header class="header-1">
      <div class="logo">
        <a href="webThuCung.html">
          <img src="images/logo.avif" alt="logo" />
        </a>
      </div>
      <form action="#" method="get" class="search-form" id="search-form">
        <input
          type="text"
          name="search"
          placeholder="Search pets..."
          id="search-input"
        />
        <button class="button" type="submit">Search</button>
      </form>
      <nav class="nav">
        <ul class="nav-list">
          <li><a href="webThuCung.html">Home</a></li>
          <li><a href="product.html">Product</a></li>
          <li><a href="#con">Contact</a></li>
          <li id="auth-links" class="fasUsers">
            <a href="login.html" id="login-link">Login</a>
            <a href="register.html" id="register-link">Register</a>
          </li>
          <li id="account-link" style="display: none">
            <a href="account.html">My Account</a>
            <a href="#" id="logout-link">Logout</a>
          </li>
          <li>
            <a href="cart.html" id="cart-link"
              >Cart(<span id="cart-count">0</span>)</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <main class="product-detail-container">
      <div class="product-layout" id="detailContent">
        <div class="loading">Loading...</div>
      </div>
    </main>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Gi·ªè h√†ng</h2>
        <div id="cartItems"></div>
        <div class="cart-total">
          <strong>T·ªïng c·ªông: $<span id="cartTotal">0</span></strong>
        </div>
        <button id="checkoutBtn" class="btn">Thanh to√°n</button>
      </div>
    </div>

    <script type="module">
      import { petsData } from "./js/mock-data.js";
      import confetti from "https://cdn.skypack.dev/canvas-confetti";

      // Authentication state management
      function updateAuthState() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        const authLinks = document.getElementById("auth-links");
        const accountLink = document.getElementById("account-link");
        const loginLink = document.getElementById("login-link");
        const registerLink = document.getElementById("register-link");
        const logoutLink = document.getElementById("logout-link");

        if (currentUser) {
          authLinks.style.display = "none";
          accountLink.style.display = "block";
          accountLink.querySelector(
            "a"
          ).textContent = `Hi, ${currentUser.userName}`;
        } else {
          authLinks.style.display = "block";
          accountLink.style.display = "none";
        }

        // Logout functionality
        logoutLink?.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("currentUser");
          localStorage.removeItem("cart");
          window.location.href = "webThuCung.html";
        });
      }

      // Cart functionality
      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const total = cart.reduce((sum, item) => sum + item.quantity, 0);
        const countEl = document.getElementById("cart-count");
        if (countEl) countEl.textContent = total;
      }

      function loadCart() {
        const cartItemsEl = document.getElementById("cartItems");
        const cartTotalEl = document.getElementById("cartTotal");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        cartItemsEl.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("cart-item");
          itemEl.innerHTML = `
            <img src="${item.image}" alt="${item.name}">
            <div class="cart-item-details">
              <h4>${item.name}</h4>
              <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
              <p>ƒê∆°n gi√°: $${item.price}</p>
              <p>T·ªïng: $${item.price * item.quantity}</p>
            </div>
            <div class="cart-item-actions">
              <button class="btn remove" data-index="${index}">X√≥a</button>
            </div>
          `;
          cartItemsEl.appendChild(itemEl);
          total += item.price * item.quantity;
        });

        cartTotalEl.textContent = total.toLocaleString("vi-VN");

        // Add remove functionality
        document.querySelectorAll(".remove").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = e.target.dataset.index;
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            loadCart();
            updateCartCount();
          });
        });
      }

      // Cart modal functionality
      const cartModal = document.getElementById("cartModal");
      const cartLink = document.getElementById("cart-link");
      const closeModalBtn = document.querySelector(".close");

      if (cartLink && cartModal && closeModalBtn) {
        cartLink.addEventListener("click", (e) => {
          e.preventDefault();
          cartModal.style.display = "block";
          loadCart();
        });

        closeModalBtn.addEventListener("click", () => {
          cartModal.style.display = "none";
        });

        window.addEventListener("click", (e) => {
          if (e.target === cartModal) {
            cartModal.style.display = "none";
          }
        });
      }

      // Checkout functionality
      document.getElementById("checkoutBtn")?.addEventListener("click", () => {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        if (cart.length === 0) {
          alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!");
          return;
        }

        alert("C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng!");
        localStorage.removeItem("cart");
        loadCart();
        updateCartCount();
        cartModal.style.display = "none";

        // Add confetti effect
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
        });
      });

      // Helper functions for reviews
      function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let stars = "‚òÖ".repeat(fullStars);
        if (hasHalfStar && fullStars < 5) {
          stars += "‚òÜ";
        }
        stars += "‚òÜ".repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
        return stars;
      }

      function calculateAverageRating(reviews, defaultRating) {
        if (reviews.length === 0) return defaultRating;
        const sum = reviews.reduce((acc, review) => acc + review.rating, 0);
        return sum / reviews.length;
      }

      // Main product detail logic
      function renderProductDetail() {
        const user = JSON.parse(localStorage.getItem("currentUser"));
        if (!user) {
          alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem chi ti·∫øt s·∫£n ph·∫©m!");
          window.location.href = "login.html";
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get("id"));
        const pet = petsData.find((p) => p.id === id);
        const container = document.getElementById("detailContent");

        if (!pet) {
          container.innerHTML = `
            <div class="error-message">
              <h2>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!</h2>
              <p>S·∫£n ph·∫©m b·∫°n ƒëang t√¨m ki·∫øm kh√¥ng t·ªìn t·∫°i.</p>
              <a href="webThuCung.html" class="btn">Quay v·ªÅ trang ch·ªß</a>
            </div>
          `;
        } else {
          // Load reviews for this product
          const allReviews =
            JSON.parse(localStorage.getItem("productReviews")) || {};
          const productReviews = allReviews[id] || [];
          const avgRating = calculateAverageRating(
            productReviews,
            pet.reviews.rating
          );
          const reviewCount = productReviews.length || pet.reviews.count;

          // Related products: same type, exclude current, limit 4
          const relatedProducts = petsData
            .filter((p) => p.id !== pet.id && p.type === pet.type)
            .slice(0, 4);

          container.innerHTML = `
            <div class="product-detail-wrapper">
              <div class="product-detail-grid">
                <div class="product-image-column">
                  <div class="image-container">
                    <img src="${pet.image}" class="product-detail-image" alt="${
            pet.name
          }" />
                  </div>
                </div>
                <div class="product-info-column">
                  <h1 class="product-title">${pet.name}</h1>
                  <div class="product-rating-header">
                    <div class="product-rating">
                      <span class="rating-value">${avgRating.toFixed(1)}</span>
                      <div class="stars-container">
                        ${generateStarRating(avgRating)}
                      </div>
                      <span class="review-count">(${reviewCount} ƒë√°nh gi√°)</span>
                    </div>
                  </div>
                  <div class="product-price-section">
                    <span class="product-price">$${pet.price.toLocaleString(
                      "vi-VN"
                    )}</span>
                  </div>
                  <div class="product-details-card">
                    <h3 class="details-title">Th√¥ng tin chi ti·∫øt</h3>
                    <div class="product-details">
                      <div class="detail-item">
                        <span class="detail-label">Gi·ªëng:</span>
                        <span class="detail-value">${pet.breed}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Tu·ªïi:</span>
                        <span class="detail-value">${pet.age}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Gi·ªõi t√≠nh:</span>
                        <span class="detail-value">${pet.gender}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">ƒê√£ ti√™m ph√≤ng:</span>
                        <span class="detail-value">${
                          pet.vaccinated ? "‚úÖ C√≥" : "‚ùå Ch∆∞a"
                        }</span>
                      </div>
                    </div>
                  </div>
                  <div class="product-description-card">
                    <h3 class="description-title">M√¥ t·∫£ s·∫£n ph·∫©m</h3>
                    <p class="description-text">${pet.description}</p>
                  </div>
                  <div class="quantity-section">
                    <label for="quantityInput" class="quantity-label">S·ªë l∆∞·ª£ng:</label>
                    <div class="quantity-selector">
                      <button type="button" id="decreaseQuantity" class="quantity-btn" aria-label="Gi·∫£m s·ªë l∆∞·ª£ng">‚àí</button>
                      <input 
                        type="number" 
                        id="quantityInput" 
                        class="quantity-input" 
                        value="1" 
                        min="1" 
                        max="99"
                        aria-label="S·ªë l∆∞·ª£ng s·∫£n ph·∫©m"
                      />
                      <button type="button" id="increaseQuantity" class="quantity-btn" aria-label="TƒÉng s·ªë l∆∞·ª£ng">+</button>
                    </div>
                  </div>
                  <div class="product-actions">
                    <button id="addToCartBtn" class="btn add-to-cart-btn">
                      <span class="btn-icon">üõí</span>
                      Th√™m v√†o gi·ªè h√†ng
                    </button>
                    <a href="webThuCung.html" class="btn secondary-btn">
                      <span class="btn-icon">‚Üê</span>
                      Ti·∫øp t·ª•c mua s·∫Øm
                    </a>
                  </div>
                </div>
              </div>

              <!-- Reviews Section -->
              <div class="reviews-section">
                <div class="reviews-header">
                  <h2 class="reviews-title">
                    <span class="title-icon">‚≠ê</span>
                    ƒê√°nh gi√° s·∫£n ph·∫©m
                  </h2>
                  <button id="writeReviewBtn" class="btn write-review-btn">
                    Vi·∫øt ƒë√°nh gi√°
                  </button>
                </div>

                <!-- Review Form -->
                <div id="reviewForm" class="review-form-container" style="display: none;">
                  <h3>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h3>
                  <form id="submitReviewForm">
                    <div class="form-group">
                      <label>ƒê√°nh gi√° c·ªßa b·∫°n:</label>
                      <div class="star-rating-input" id="starRating">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                      </div>
                      <input type="hidden" id="ratingValue" value="0" required>
                    </div>
                    <div class="form-group">
                      <label for="reviewComment">Nh·∫≠n x√©t:</label>
                      <textarea id="reviewComment" rows="4" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m n√†y..." required></textarea>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn submit-review-btn">G·ª≠i ƒë√°nh gi√°</button>
                      <button type="button" class="btn cancel-review-btn" id="cancelReviewBtn">H·ªßy</button>
                    </div>
                  </form>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list" id="reviewsList">
                  ${
                    productReviews.length > 0
                      ? productReviews
                          .map(
                            (review) => `
                      <div class="review-item">
                        <div class="review-header">
                          <div class="reviewer-info">
                            <div class="reviewer-avatar">${review.userName
                              .charAt(0)
                              .toUpperCase()}</div>
                            <div class="reviewer-details">
                              <h4 class="reviewer-name">${review.userName}</h4>
                              <span class="review-date">${new Date(
                                review.date
                              ).toLocaleDateString("vi-VN")}</span>
                            </div>
                          </div>
                          <div class="review-rating-display">
                            ${generateStarRating(review.rating)}
                          </div>
                        </div>
                        <p class="review-comment">${review.comment}</p>
                      </div>
                    `
                          )
                          .join("")
                      : '<div class="no-reviews">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° s·∫£n ph·∫©m n√†y!</div>'
                  }
                </div>
              </div>
              <!-- Related Products Section -->
              <div class="related-products-section">
                <h2 class="related-title">
                  <span class="title-icon">ü¶¥</span>
                  Th√∫ c∆∞ng li√™n quan
                </h2>
                <div class="related-grid">
                  ${
                    relatedProducts.length > 0
                      ? relatedProducts
                          .map(
                            (rp) => `
                      <div class="related-card" data-id="${rp.id}">
                        <div class="related-image-wrapper">
                          <img src="${rp.image}" alt="${rp.name}" class="related-image" />
                        </div>
                        <div class="related-info">
                          <h3 class="related-name">${rp.name}</h3>
                          <p class="related-breed">${rp.breed}</p>
                          <p class="related-price">$${rp.price.toLocaleString("vi-VN")}</p>
                          <button class="btn related-detail-btn" data-id="${rp.id}">
                            Xem chi ti·∫øt
                          </button>
                        </div>
                      </div>
                    `
                          )
                          .join("")
                      : '<p class="no-related">Hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m li√™n quan.</p>'
                  }
                </div>
              </div>
            </div>
          `;

          // Quantity selector functionality
          const quantityInput = document.getElementById("quantityInput");
          const decreaseBtn = document.getElementById("decreaseQuantity");
          const increaseBtn = document.getElementById("increaseQuantity");

          decreaseBtn.addEventListener("click", () => {
            let currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue > 1) {
              quantityInput.value = currentValue - 1;
            }
          });

          increaseBtn.addEventListener("click", () => {
            let currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue < 99) {
              quantityInput.value = currentValue + 1;
            }
          });

          quantityInput.addEventListener("change", () => {
            let value = parseInt(quantityInput.value) || 1;
            if (value < 1) {
              quantityInput.value = 1;
            } else if (value > 99) {
              quantityInput.value = 99;
            }
          });

          // Add to cart functionality
          document
            .getElementById("addToCartBtn")
            .addEventListener("click", () => {
              let cart = JSON.parse(localStorage.getItem("cart")) || [];
              const quantity = parseInt(quantityInput.value) || 1;
              const existing = cart.find((item) => item.id === pet.id);

              if (existing) {
                existing.quantity += quantity;
              } else {
                cart.push({ ...pet, quantity: quantity });
              }

              localStorage.setItem("cart", JSON.stringify(cart));
              updateCartCount();
              alert(`ƒê√£ th√™m ${quantity} s·∫£n ph·∫©m v√†o gi·ªè h√†ng!`);
              // Reset quantity to 1 after adding
              quantityInput.value = 1;
            });

          // Related products navigation
          document.querySelectorAll(".related-detail-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const targetId = e.currentTarget.dataset.id;
              window.location.href = `productDetail.html?id=${targetId}`;
            });
          });

          // Review functionality
          setupReviewFunctionality(id, user);
        }
      }

      function setupReviewFunctionality(productId, user) {
        const allReviews =
          JSON.parse(localStorage.getItem("productReviews")) || {};
        const productReviews = allReviews[productId] || [];

        // Star rating input
        const stars = document.querySelectorAll(".star-rating-input .star");
        const ratingInput = document.getElementById("ratingValue");
        let selectedRating = 0;

        stars.forEach((star, index) => {
          star.addEventListener("mouseenter", () => {
            highlightStars(index + 1);
          });
          star.addEventListener("click", () => {
            selectedRating = index + 1;
            ratingInput.value = selectedRating;
            highlightStars(selectedRating);
          });
        });

        document
          .querySelector(".star-rating-input")
          ?.addEventListener("mouseleave", () => {
            highlightStars(selectedRating);
          });

        function highlightStars(count) {
          stars.forEach((star, index) => {
            if (index < count) {
              star.textContent = "‚òÖ";
              star.style.color = "#ffd700";
            } else {
              star.textContent = "‚òÜ";
              star.style.color = "#ccc";
            }
          });
        }

        // Show/hide review form
        const writeReviewBtn = document.getElementById("writeReviewBtn");
        const reviewForm = document.getElementById("reviewForm");
        const cancelReviewBtn = document.getElementById("cancelReviewBtn");

        writeReviewBtn?.addEventListener("click", () => {
          reviewForm.style.display =
            reviewForm.style.display === "none" ? "block" : "none";
        });

        cancelReviewBtn?.addEventListener("click", () => {
          reviewForm.style.display = "none";
          document.getElementById("submitReviewForm").reset();
          selectedRating = 0;
          ratingInput.value = 0;
          highlightStars(0);
        });

        // Submit review
        const submitReviewForm = document.getElementById("submitReviewForm");
        submitReviewForm?.addEventListener("submit", (e) => {
          e.preventDefault();
          const rating = parseInt(ratingInput.value);
          const comment = document.getElementById("reviewComment").value;

          if (rating === 0) {
            alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!");
            return;
          }

          const newReview = {
            id: Date.now(),
            productId: productId,
            userName: user.userName,
            rating: rating,
            comment: comment,
            date: new Date().toISOString(),
          };

          if (!allReviews[productId]) {
            allReviews[productId] = [];
          }
          allReviews[productId].unshift(newReview);
          localStorage.setItem("productReviews", JSON.stringify(allReviews));

          alert("C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!");
          submitReviewForm.reset();
          selectedRating = 0;
          ratingInput.value = 0;
          highlightStars(0);
          reviewForm.style.display = "none";

          // Reload page to show new review
          location.reload();
        });
      }

      // Initialize
      updateAuthState();
      updateCartCount();
      renderProductDetail();
    </script>
    <script src="js/search.js"></script>
  </body>
</html>
